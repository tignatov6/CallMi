<!DOCTYPE html><html lang="ru"><head>
<meta charset="utf-8" />
<title>Python Call Site</title>
<style>
 body{font-family:sans-serif;} #rooms{margin-bottom:1rem;}
 video,audio{display:none;} .hidden{display:none;}
</style>
</head><body>
<h1>–ó–≤–æ–Ω–∫–∏</h1>

<div id="login">
  –í–∞—à–µ –∏–º—è: <input id="userName" placeholder="–ò–º—è"> 
  –ê–≤–∞—Ç–∞—Ä: <input id="avatarUrl" placeholder="https://...jpg">
  <button id="enterBtn">–í–æ–π—Ç–∏</button>
</div>

<div id="main" class="hidden">
  <section id="rooms"></section>

  <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
  –ù–∞–∑–≤–∞–Ω–∏–µ: <input id="roomName">
  –ü–∞—Ä–æ–ª—å (–æ–ø—Ü.): <input id="roomPwd" type="password">
  <button id="createRoom">–°–æ–∑–¥–∞—Ç—å</button>

  <h2 id="roomTitle" class="hidden">–ö–æ–º–Ω–∞—Ç–∞: <span id="currentRoom"></span></h2>
  <div id="controls" class="hidden">
    <button id="leave">–í—ã–π—Ç–∏</button>
    <button id="muteMic">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª.</button>
    <button id="muteSpk">–î–∏–Ω–∞–º–∏–∫–∏ –≤—ã–∫–ª.</button><br/>
    –ì—Ä–æ–º–∫–æ—Å—Ç—å –≤—Ö–æ–¥.: <input id="inVol" type="range" min="0" max="250" value="100">
    –ú–∏–∫—Ä–æ—Ñ–æ–Ω:       <input id="outVol" type="range" min="0" max="250" value="100">
  </div>
</div>

<script>
let token={}, ws=null, pc=null, localStream=null,
    roomsDiv=document.getElementById('rooms');

const gainCtx = new AudioContext();
let inGain = gainCtx.createGain();
let micGain = gainCtx.createGain();

document.getElementById('enterBtn').onclick = ()=>{
  token.name = userName.value || '–ì–æ—Å—Ç—å'+Math.random().toString(36).slice(2,5);
  token.avatar = avatarUrl.value || 'https://placekitten.com/64/64';
  login.classList.add('hidden'); main.classList.remove('hidden');
  loadRooms();
};
document.getElementById('createRoom').onclick = async ()=>{
  const r = await fetch('/api/rooms',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name:roomName.value,password:roomPwd.value})});
  if(r.ok){roomName.value='';roomPwd.value='';loadRooms();}
  else alert(await r.text());
};
async function loadRooms(){
  roomsDiv.innerHTML='–ó–∞–≥—Ä—É–∑–∫–∞...';
  const lst=await (await fetch('/api/rooms')).json();
  roomsDiv.innerHTML = lst.map(r=>
    `<button onclick="join(${r.id},'${r.name}',${r.has_password})">
       –í–æ–π—Ç–∏: ${r.name}${r.has_password?' üîí':''}</button>`).join('<br>');
}
window.join = async (id,name,hasPwd)=>{
 if(ws){alert('–£–∂–µ –≤ –∫–æ–º–Ω–∞—Ç–µ');return;}
 const pwd = hasPwd?prompt('–ü–∞—Ä–æ–ª—å'):'';
 ws = new WebSocket(`ws://${location.host}/ws/${id}`);
 ws.onopen = ()=> ws.send(JSON.stringify({password:pwd}));
 ws.onmessage = e=> handleSignal(JSON.parse(e.data));
 ws.onclose = ()=> cleanup();

 roomTitle.classList.remove('hidden'); controls.classList.remove('hidden');
 currentRoom.textContent = name;
 await startMedia();

 pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
 pc.onicecandidate = ({candidate})=> candidate && ws.send(JSON.stringify({ice:candidate}));
 pc.ontrack = ({streams:[s]})=>{
   // –≤—Ö–æ–¥—è—â–∏–π –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫ ‚Üí WebAudio GainNode ‚Üí destination
   const src=gainCtx.createMediaStreamSource(s);
   src.connect(inGain).connect(gainCtx.destination);
 };
 // –º–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí micGain ‚Üí peer
 localStream.getTracks().forEach(t=>pc.addTrack(micGain.stream.getAudioTracks()[0]??t, localStream));
 inGain.gain.value=1; micGain.gain.value=1;

 // –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
 const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
 ws.onopen = ()=> ws.send(JSON.stringify({sdp:pc.localDescription}));
};
async function handleSignal(msg){
 if(msg.sdp){
   await pc.setRemoteDescription(msg.sdp);
   if(msg.sdp.type==='offer'){
       const ans=await pc.createAnswer(); await pc.setLocalDescription(ans);
       ws.send(JSON.stringify({sdp:pc.localDescription}));
   }
 }else if(msg.ice){ await pc.addIceCandidate(msg.ice); }
}
async function startMedia(){
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  const dest = gainCtx.createMediaStreamDestination(); // –¥–ª—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  const src = gainCtx.createMediaStreamSource(localStream);
  src.connect(micGain).connect(dest);
  micGain.stream = dest.stream;
}
function cleanup(){
  pc&&pc.close(); pc=null; ws=null;
  roomTitle.classList.add('hidden'); controls.classList.add('hidden');
}
leave.onclick = ()=>{ ws?.close(); cleanup(); };
muteMic.onclick = ()=> localStream.getAudioTracks()[0].enabled ^= true;
muteSpk.onclick = ()=> inGain.gain.value = inGain.gain.value?0:1;
inVol.oninput = e=> inGain.gain.value = e.target.value/100 * 2.5;   // 0‚Äì2.5 (0‚Äì250 %)
outVol.oninput= e=> micGain.gain.value = e.target.value/100 * 2.5;
</script>
</body></html>
