<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Python Call Site</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 1em auto; }
        #rooms { margin-bottom: 1rem; }
        #audio-container, video { display: none; }
        .hidden { display: none; }
        button { margin: 0.2em; padding: 0.5em; }
        input { margin: 0.2em; padding: 0.4em; }
        #usersList { border: 1px solid #ccc; padding: 0.5em; min-height: 50px; margin-top: 1em; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
        .user-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
        }
        
        .user-name {
            font-weight: bold;
            margin-right: 10px;
            min-width: 120px;
        }
        
        .volume-indicator {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 0 10px;
        }
        
        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #FFC107 70%, #F44336 100%);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 10px;
        }
        
        .volume-text {
            font-size: 12px;
            color: #666;
            min-width: 60px;
            text-align: right;
        }
        
        .speaking {
            background: #e8f5e8;
            border-color: #4CAF50;
        }
        
        .muted {
            opacity: 0.6;
            background: #f0f0f0;
        }
        
        .muted .volume-bar {
            background: #999;
        }
    </style>
</head>
<body>
    <h1>–ó–≤–æ–Ω–∫–∏</h1>

    <div id="login">
        –í–∞—à–µ –∏–º—è: <input id="userName" placeholder="–ò–º—è">
        <button id="enterBtn">–í–æ–π—Ç–∏</button>
    </div>

    <div id="main" class="hidden">
        <section id="rooms"></section>
        <button id="refreshRooms" style="margin-top: 10px; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç</button>

        <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
        –ù–∞–∑–≤–∞–Ω–∏–µ: <input id="roomName">
        –ü–∞—Ä–æ–ª—å (–æ–ø—Ü.): <input id="roomPwd" type="password">
        <button id="createRoom">–°–æ–∑–¥–∞—Ç—å</button>

        <div id="callUI" class="hidden">
            <h2 id="roomTitle">–ö–æ–º–Ω–∞—Ç–∞: <span id="currentRoom"></span></h2>
            <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>
            <div id="usersList"></div>
            <div id="controls">
                <button id="leave">–í—ã–π—Ç–∏</button>
                <button id="muteMic">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª.</button>
                <!-- –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª MuteSpk –∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ —É–±—Ä–∞–Ω –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, —Ç.–∫. –∞—É–¥–∏–æ —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
    
    <div id="audio-container"></div>

<script>
// ‚ïê‚ïê‚ïê CONFIGURATION ‚ïê‚ïê‚ïê
const CONFIG = {
    // Auto-refresh intervals (in milliseconds)
    ROOM_LIST_REFRESH_INTERVAL: 30000,  // 30 seconds for room list
    USER_LIST_REFRESH_INTERVAL: 10000,  // 10 seconds for user list
    VOLUME_UPDATE_INTERVAL: 100,        // 100ms for volume updates
    
    // Audio settings
    VOLUME_NOISE_THRESHOLD: 2,           // Suppress volume below 2%
    VOLUME_SPEAKING_THRESHOLD: 10,       // Consider speaking above 10%
    
    // WebSocket settings
    RECONNECT_DELAY: 1000,               // 1 second delay for reconnection attempts
};

// ‚ïê‚ïê‚ïê GLOBAL VARIABLES ‚ïê‚ïê‚ïê
let myPeerId = null, myName = null, ws = null, localStream = null;
let mainMenuWs = null; // WebSocket –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
let peerConnections = {}; // { peerId: RTCPeerConnection }
let audioAnalyzers = {}; // { peerId: AudioAnalyzer }
let volumeMeters = {}; // { peerId: { analyser, dataArray, lastUpdate } }
let localAudioAnalyzer = null; // –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
let roomRefreshInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
let userRefreshInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const roomsDiv = document.getElementById('rooms');

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
function connectToMainMenu() {
    if (mainMenuWs) {
        console.log('‚úÖ WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        return;
    }
    
    try {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${location.host}/main-menu/${myPeerId}/${encodeURIComponent(myName)}`;
        
        mainMenuWs = new WebSocket(wsUrl);
        
        mainMenuWs.onopen = () => {
            console.log('üè† –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        };
        
        mainMenuWs.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                if (message.type === 'rooms_updated') {
                    const eventType = message.event || 'unknown';
                    const eventEmojis = {
                        'room_created': 'üè†',
                        'room_deleted': 'üóëÔ∏è',
                        'room_updated': 'üîÑ'
                    };
                    const emoji = eventEmojis[eventType] || 'üì¢';
                    
                    console.log(`${emoji} –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–±—ã—Ç–∏–∏: ${eventType}`);
                    loadRooms(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é:', error);
            }
        };
        
        mainMenuWs.onclose = () => {
            console.log('üè† WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –∑–∞–∫—Ä—ã—Ç');
            mainMenuWs = null;
        };
        
        mainMenuWs.onerror = (error) => {
            console.error('‚ùå –û—à–∏–±–∫–∞ WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é:', error);
        };
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é:', error);
    }
}

function disconnectFromMainMenu() {
    if (mainMenuWs && mainMenuWs.readyState !== WebSocket.CLOSED) {
        console.log('üè† –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é');
        mainMenuWs.close();
        mainMenuWs = null;
    }
}
function createAudioAnalyzer(stream, peerId) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
        if (volumeMeters[peerId] && volumeMeters[peerId].isRunning) {
            console.log(`‚úÖ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è ${peerId} —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ`);
            return volumeMeters[peerId];
        }
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        if (volumeMeters[peerId] && !volumeMeters[peerId].isRunning) {
            console.log(`üßΩ –û—á–∏—â–∞–µ–º –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è ${peerId}`);
            if (volumeMeters[peerId].audioContext) {
                volumeMeters[peerId].audioContext.close();
            }
            delete volumeMeters[peerId];
        }
        
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        const analyser = audioContext.createAnalyser();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.85; // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –±–æ–ª—å—à–µ–≥–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
        source.connect(analyser);
        
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        volumeMeters[peerId] = {
            analyser: analyser,
            dataArray: dataArray,
            lastUpdate: 0,
            audioContext: audioContext,
            smoothedVolume: 0, // –î–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
            isRunning: false,
            stream: stream // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ—Ç–æ–∫
        };
        
        console.log(`üìä –ê—É–¥–∏–æ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω –¥–ª—è ${peerId}`);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
            if (volumeMeters[peerId] && !volumeMeters[peerId].isRunning) {
                startVolumeMonitoring(peerId);
            }
        }, 100);
        
        return { analyser, dataArray, audioContext };
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –¥–ª—è ${peerId}:`, error);
        return null;
    }
}

function calculateVolume(analyser, dataArray) {
    try {
        analyser.getByteFrequencyData(dataArray);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        let sum = 0;
        let sampleCount = 0;
        
        // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ —á–∞—Å—Ç–æ—Ç–∞—Ö —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞ (300Hz - 3400Hz)
        const voiceStart = Math.floor(dataArray.length * 0.1); // –ü—Ä–∏–º–µ—Ä–Ω–æ 300Hz
        const voiceEnd = Math.floor(dataArray.length * 0.7);   // –ü—Ä–∏–º–µ—Ä–Ω–æ 3400Hz
        
        for (let i = voiceStart; i < voiceEnd; i++) {
            sum += dataArray[i] * dataArray[i]; // RMS –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ
            sampleCount++;
        }
        
        if (sampleCount === 0) {
            return 0;
        }
        
        const rms = Math.sqrt(sum / sampleCount);
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
        const normalizedRms = rms / 255;
        const volume = Math.min(100, normalizedRms * 200); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ NaN –∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å
        return isNaN(volume) || !isFinite(volume) ? 0 : volume;
    } catch (error) {
        console.warn('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏:', error);
        return 0;
    }
}

function startVolumeMonitoring(peerId) {
    const meter = volumeMeters[peerId];
    if (!meter || meter.isRunning) return;
    
    meter.isRunning = true;
    const { analyser, dataArray } = meter;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–≥–ª–∞–∂–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (typeof meter.smoothedVolume === 'undefined') {
        meter.smoothedVolume = 0;
    }
    
    // –°—á–µ—Ç—á–∏–∫ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    let stabilizationCounter = 0;
    const STABILIZATION_PERIOD = 10; // 10 –∏—Ç–µ—Ä–∞—Ü–∏–π –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
    
    function updateVolume() {
        if (!volumeMeters[peerId] || !volumeMeters[peerId].isRunning) return;
        
        try {
            const rawVolume = calculateVolume(analyser, dataArray);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
            let alpha;
            if (stabilizationCounter < STABILIZATION_PERIOD) {
                // –í –Ω–∞—á–∞–ª–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª—å—à–µ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
                alpha = 0.05; // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
                stabilizationCounter++;
            } else {
                // –ü–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
                const volumeDiff = Math.abs(rawVolume - volumeMeters[peerId].smoothedVolume);
                if (volumeDiff > 20) {
                    alpha = 0.3; // –ë—ã—Å—Ç—Ä–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ —Ä–µ–∑–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
                } else if (volumeDiff > 5) {
                    alpha = 0.15; // –£–º–µ—Ä–µ–Ω–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
                } else {
                    alpha = 0.08; // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –º–∞–ª—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
                }
            }
            
            const currentSmoothed = volumeMeters[peerId].smoothedVolume;
            const newSmoothed = currentSmoothed + alpha * (rawVolume - currentSmoothed);
            
            volumeMeters[peerId].smoothedVolume = newSmoothed;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞
            const displayVolume = newSmoothed < CONFIG.VOLUME_NOISE_THRESHOLD ? 0 : newSmoothed; // –ü–æ–¥–∞–≤–ª—è–µ–º —à—É–º
            updateVolumeDisplay(peerId, displayVolume);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ CONFIG.VOLUME_UPDATE_INTERVAL –º—Å –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            setTimeout(updateVolume, CONFIG.VOLUME_UPDATE_INTERVAL);
            
        } catch (error) {
            console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–ª—è ${peerId}:`, error);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            setTimeout(updateVolume, CONFIG.VOLUME_UPDATE_INTERVAL);
        }
    }
    
    console.log(`üìà –ó–∞–ø—É—â–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–ª—è ${peerId}`);
    updateVolume();
}

function updateVolumeDisplay(peerId, volume) {
    const volumeBar = document.getElementById(`volume-bar-${peerId}`);
    const volumeText = document.getElementById(`volume-text-${peerId}`);
    const userItem = document.getElementById(`user-item-${peerId}`);
    
    if (volumeBar && volumeText && userItem) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        const safeVolume = isNaN(volume) || !isFinite(volume) ? 0 : Math.max(0, Math.min(100, volume));
        
        volumeBar.style.width = `${safeVolume}%`;
        volumeText.textContent = `${Math.round(safeVolume)}%`;
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø—Ä–∏ —Ä–µ—á–∏ (–±–æ–ª–µ–µ CONFIG.VOLUME_SPEAKING_THRESHOLD%)
        if (safeVolume > CONFIG.VOLUME_SPEAKING_THRESHOLD) {
            userItem.classList.add('speaking');
        } else {
            userItem.classList.remove('speaking');
        }
    }
}

function createUserVolumeIndicator(peerId, peerName) {
    const userItem = document.createElement('div');
    userItem.id = `user-item-${peerId}`;
    userItem.className = 'user-item';
    
    userItem.innerHTML = `
        <div class="user-name">${peerName}</div>
        <div class="volume-indicator">
            <div class="volume-bar" id="volume-bar-${peerId}"></div>
        </div>
        <div class="volume-text" id="volume-text-${peerId}">0%</div>
    `;
    
    return userItem;
}

function removeVolumeAnalyzer(peerId) {
    if (volumeMeters[peerId]) {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        volumeMeters[peerId].isRunning = false;
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º AudioContext
        if (volumeMeters[peerId].audioContext) {
            volumeMeters[peerId].audioContext.close();
        }
        delete volumeMeters[peerId];
        console.log(`üßΩ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω –¥–ª—è ${peerId}`);
    }
    
    // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const userItem = document.getElementById(`user-item-${peerId}`);
    if (userItem) {
        userItem.remove();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function startUserAutoRefresh() {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
    if (userRefreshInterval) {
        clearInterval(userRefreshInterval);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ CONFIG.USER_LIST_REFRESH_INTERVAL –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
    userRefreshInterval = setInterval(() => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ –∏ –µ—Å—Ç—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        if (ws && ws.readyState === WebSocket.OPEN) {
            console.log('üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            ws.send(JSON.stringify({ type: 'refresh_users' }));
        }
    }, CONFIG.USER_LIST_REFRESH_INTERVAL);
    
    console.log(`‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–ø—É—â–µ–Ω–æ (–∫–∞–∂–¥—ã–µ ${CONFIG.USER_LIST_REFRESH_INTERVAL/1000} —Å–µ–∫—É–Ω–¥)`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function stopUserAutoRefresh() {
    if (userRefreshInterval) {
        clearInterval(userRefreshInterval);
        userRefreshInterval = null;
        console.log('‚èπÔ∏è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    }
}

// --- –í—Ö–æ–¥ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç (—Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏) ---
document.getElementById('enterBtn').onclick = () => {
    myName = userName.value || '–ì–æ—Å—Ç—å' + Math.random().toString(36).slice(2, 5);
    myPeerId = `peer_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`; // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
    login.classList.add('hidden');
    main.classList.remove('hidden');
    loadRooms();
    
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    connectToMainMenu();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
    startRoomAutoRefresh();
};

document.getElementById('createRoom').onclick = async () => {
    try {
        const r = await fetch('/api/rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: roomName.value, password: roomPwd.value })
        });
        
        if (r.ok) {
            const newRoom = await r.json();
            console.log(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞ "${newRoom.name}" —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!`);
            roomName.value = ''; 
            roomPwd.value = '';
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
            loadRooms();
        } else {
            const errorText = await r.text();
            alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ${errorText}`);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–Ω–∞—Ç—ã:', error);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–Ω–∞—Ç—ã.');
    }
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
document.getElementById('refreshRooms').onclick = () => {
    console.log('üîÑ –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç...');
    loadRooms();
};

async function loadRooms() {
    try {
        roomsDiv.innerHTML = 'üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç...';
        const response = await fetch('/api/rooms');
        
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);
        }
        
        const lst = await response.json();
        
        if (lst.length === 0) {
            roomsDiv.innerHTML = 'üè† –ö–æ–º–Ω–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!';
        } else {
            roomsDiv.innerHTML = lst.map(r =>
                `<button onclick="join(${r.id},'${r.name}',${r.has_password})" style="display: block; width: 100%; margin: 5px 0; padding: 10px; text-align: left; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; cursor: pointer;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                üí¨ ${r.name}${r.has_password ? ' üîí' : ' üîì'}
                </button>`
            ).join('');
        }
        
        console.log(`‚úÖ –°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${lst.length}`);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç:', error);
        roomsDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç: ${error.message}`;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
function startRoomAutoRefresh() {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
    if (roomRefreshInterval) {
        clearInterval(roomRefreshInterval);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ CONFIG.ROOM_LIST_REFRESH_INTERVAL –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
    roomRefreshInterval = setInterval(() => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ
        if (!ws) {
            console.log('üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç...');
            loadRooms();
        }
    }, CONFIG.ROOM_LIST_REFRESH_INTERVAL);
    
    console.log(`‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç –∑–∞–ø—É—â–µ–Ω–æ (–∫–∞–∂–¥—ã–µ ${CONFIG.ROOM_LIST_REFRESH_INTERVAL/1000} —Å–µ–∫—É–Ω–¥)`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
function stopRoomAutoRefresh() {
    if (roomRefreshInterval) {
        clearInterval(roomRefreshInterval);
        roomRefreshInterval = null;
        console.log('‚èπÔ∏è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    }
}


// --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ò WEBRTC ---

window.join = async (id, name, hasPwd) => {
    if (ws) { alert('–£–∂–µ –≤ –∫–æ–º–Ω–∞—Ç–µ'); return; }
    let pwd = '';
    if (hasPwd) {
        pwd = prompt('–ü–∞—Ä–æ–ª—å –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã "' + name + '"');
        if (pwd === null) return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞"
    }

    try {
        await startMedia(); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞—Ä–∞–Ω–µ–µ

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${location.host}/ws/${id}/${myPeerId}/${encodeURIComponent(myName)}${pwd ? '?password=' + encodeURIComponent(pwd) : ''}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log("WebSocket connection established");
            callUI.classList.remove('hidden');
            currentRoom.textContent = name;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            stopRoomAutoRefresh();
            
            // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
            disconnectFromMainMenu();
            
            startUserAutoRefresh();
        };
        
        ws.onmessage = e => handleWsMessage(JSON.parse(e.data));
        
        ws.onclose = (event) => {
            console.log('WebSocket closed:', event.code, event.reason);
            if (event.code >= 4000) {
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: ${event.reason}`);
            }
            cleanup();
        };
        
        ws.onerror = (err) => {
            console.error("WebSocket error:", err);
            alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.");
            cleanup();
        };

    } catch (err) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É:", err);
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            alert('–û—à–∏–±–∫–∞: –í—ã –Ω–µ —Ä–∞–∑—Ä–µ—à–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.');
        } else {
            alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ${err.message}`);
        }
        cleanup();
    }
};

async function handleWsMessage(msg) {
    console.log("Received message:", msg);
    const { type, payload, from_id } = msg;

    switch (type) {
        // –°–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∏–ª –Ω–∞–º, –∫—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–º–Ω–∞—Ç–µ
        case 'room_state':
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–µ–±—è –∏–∑ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
            const otherUsers = payload.filter(peer => peer.id !== myPeerId);
            const allUsers = otherUsers.concat({id: myPeerId, name: `${myName} (–í—ã)`});
            updateUsersList(allUsers);
            
            // –°–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å –Ω–æ–≤—ã–º–∏ –ø–∏—Ä–∞–º–∏ (–Ω–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏)
            for (const peer of otherUsers) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —ç—Ç–∏–º –ø–∏—Ä–æ–º
                if (peerConnections[peer.id]) {
                    console.log(`‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peer.name} (${peer.id}) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
                    continue;
                }
                
                console.log(`üîó –°–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ù–û–í–´–ú –ø–∏—Ä–æ–º: ${peer.name} (${peer.id})`);
                const pc = createPeerConnection(peer.id, peer.name);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º offer
                const senders = pc.getSenders();
                console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º offer –¥–ª—è ${peer.name}:`, senders.length);
                
                try {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    console.log(`üìû –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer –¥–ª—è –ù–û–í–û–ì–û —É—á–∞—Å—Ç–Ω–∏–∫–∞ ${peer.name}`);
                    ws.send(JSON.stringify({ to_id: peer.id, type: 'sdp', payload: pc.localDescription }));
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer –¥–ª—è ${peer.name}:`, error);
                }
            }
            break;

        // –í –∫–æ–º–Ω–∞—Ç—É –≤–æ—à–µ–ª –Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫
        case 'new_peer':
            // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫ –∏ –Ω–µ —Å–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–æ–±–æ–π
            if (payload.id === myPeerId) {
                console.log(`‚è≠Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏: ${payload.name}`);
                break;
            }
            
            updateUsersList(null, payload);
            
            // –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–∑–¥–∞—Å—Ç offer, –º—ã –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º PC –∏ –∂–¥–µ–º
            console.log(`üëã –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: ${payload.name} (${payload.id})`);
            const newPc = createPeerConnection(payload.id, payload.name);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã
            const senders = newPc.getSenders();
            console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ${payload.name}:`, senders.length);
            break;

        // –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É
        case 'peer_left':
            updateUsersList(null, null, payload.id);
            if (peerConnections[payload.id]) {
                peerConnections[payload.id].close();
                delete peerConnections[payload.id];
            }
            const audioEl = document.getElementById(`audio_${payload.id}`);
            if (audioEl) audioEl.remove();
            break;

        // –ü–æ–ª—É—á–∏–ª–∏ SDP (offer –∏–ª–∏ answer)
        case 'sdp':
            // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º SDP –æ—Ç —Å–∞–º–æ–≥–æ —Å–µ–±—è
            if (from_id === myPeerId) {
                console.log(`‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É SDP –æ—Ç —Å–∞–º–æ–≥–æ —Å–µ–±—è: ${from_id}`);
                break;
            }
            
            const pc = peerConnections[from_id];
            if (pc) {
                try {
                    console.log(`üì® –ü–æ–ª—É—á–µ–Ω ${payload.type} –æ—Ç ${from_id}`);
                    await pc.setRemoteDescription(new RTCSessionDescription(payload));
                    if (payload.type === 'offer') {
                        console.log(`üìù –°–æ–∑–¥–∞–µ–º answer –¥–ª—è ${from_id}`);
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        ws.send(JSON.stringify({ to_id: from_id, type: 'sdp', payload: pc.localDescription }));
                        console.log(`üì§ Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${from_id}`);
                    }
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ SDP –æ—Ç ${from_id}:`, error);
                }
            } else {
                console.error(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ PeerConnection –¥–ª—è ${from_id}`);
            }
            break;

        // –ü–æ–ª—É—á–∏–ª–∏ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç
        case 'ice':
            // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç —Å–∞–º–æ–≥–æ —Å–µ–±—è
            if (from_id === myPeerId) {
                console.log(`‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ—Ç —Å–∞–º–æ–≥–æ —Å–µ–±—è: ${from_id}`);
                break;
            }
            
            const peerConn = peerConnections[from_id];
            if (peerConn) {
                try {
                    console.log(`üßä –î–æ–±–∞–≤–ª—è–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç ${from_id}:`, payload.type);
                    await peerConn.addIceCandidate(new RTCIceCandidate(payload));
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ—Ç ${from_id}:`, error);
                }
            } else {
                console.error(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ PeerConnection –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ—Ç ${from_id}`);
            }
            break;
    }
}

function createPeerConnection(peerId, peerName) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    if (peerConnections[peerId]) {
        console.log(`‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ PeerConnection –¥–ª—è ${peerName} (${peerId})`);
        return peerConnections[peerId];
    }
    
    const pc = new RTCPeerConnection({ 
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    pc.onconnectionstatechange = () => {
        console.log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${peerName}: ${pc.connectionState}`);
        if (pc.connectionState === 'failed') {
            console.error(`–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${peerName}`);
        } else if (pc.connectionState === 'connected') {
            console.log(`–£—Å–ø–µ—à–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerName}`);
        }
    };
    
    pc.oniceconnectionstatechange = () => {
        console.log(`ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å ${peerName}: ${pc.iceConnectionState}`);
        if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
            console.warn(`–ü—Ä–æ–±–ª–µ–º—ã —Å ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º –∫ ${peerName}`);
        }
    };
    
    pc.onicegatheringstatechange = () => {
        console.log(`ICE gathering —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å ${peerName}: ${pc.iceGatheringState}`);
    };
    
    pc.onicecandidate = ({ candidate }) => {
        if (candidate) {
            console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∫ ${peerName}:`, candidate.type);
            ws.send(JSON.stringify({ to_id: peerId, type: 'ice', payload: candidate }));
        } else {
            console.log(`–°–±–æ—Ä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è ${peerName}`);
        }
    };
    
    pc.ontrack = ({ streams: [stream] }) => {
        let audioEl = document.getElementById(`audio_${peerId}`);
        if (!audioEl) {
            audioEl = document.createElement('audio');
            audioEl.id = `audio_${peerId}`;
            audioEl.autoplay = true;
            audioEl.playsInline = true;
            audioEl.volume = 1.0;
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            audioEl.onloadedmetadata = () => {
                console.log(`–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∞—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è ${peerName} (${peerId})`);
                audioEl.play().catch(err => {
                    console.warn(`–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è ${peerName}:`, err);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
                    showPlayButton(peerId, peerName, audioEl);
                });
            };
            audioEl.onplay = () => console.log(`‚ñ∂Ô∏è –ê—É–¥–∏–æ –Ω–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –¥–ª—è ${peerName}`);
            audioEl.onpause = () => console.log(`‚è∏Ô∏è –ê—É–¥–∏–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è ${peerName}`);
            audioEl.onerror = (err) => {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –∞—É–¥–∏–æ –¥–ª—è ${peerName}:`, err);
                // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞—É–¥–∏–æ
                setTimeout(() => {
                    console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ –¥–ª—è ${peerName}`);
                    audioEl.load();
                    audioEl.play().catch(e => console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:', e));
                }, 1000);
            };
            document.getElementById('audio-container').appendChild(audioEl);
        }
        audioEl.srcObject = stream;
        console.log(`–ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–ø–æ—Ç–æ–∫ –æ—Ç ${peerName} (${peerId})`);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞—É–¥–∏–æ—Ç—Ä–µ–∫–∏ –≤ –ø–æ—Ç–æ–∫–µ
        const audioTracks = stream.getAudioTracks();
        if (audioTracks.length === 0) {
            console.warn(`‚ö†Ô∏è –ù–µ—Ç –∞—É–¥–∏–æ—Ç—Ä–µ–∫–æ–≤ –≤ –ø–æ—Ç–æ–∫–µ –æ—Ç ${peerName}`);
        } else {
            console.log(`üé§ –ü–æ–ª—É—á–µ–Ω–æ ${audioTracks.length} –∞—É–¥–∏–æ—Ç—Ä–µ–∫(–æ–≤) –æ—Ç ${peerName}`);
            audioTracks.forEach((track, idx) => {
                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–µ–∫–∞
                track.onended = () => {
                    console.warn(`‚ö†Ô∏è –ê—É–¥–∏–æ—Ç—Ä–µ–∫ –æ—Ç ${peerName} –∑–∞–≤–µ—Ä—à–∏–ª—Å—è`);
                };
                track.onmute = () => console.warn(`üîá –ê—É–¥–∏–æ—Ç—Ä–µ–∫ –æ—Ç ${peerName} –∑–∞–º—É—á–µ–Ω`);
                track.onunmute = () => console.log(`üîä –ê—É–¥–∏–æ—Ç—Ä–µ–∫ –æ—Ç ${peerName} —Ä–∞–∑–º—É—á–µ–Ω`);
            });
            
            // –°–æ–∑–¥–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
            setTimeout(() => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ç–æ–∫ –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω –∏ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (stream.active && (!volumeMeters[peerId] || !volumeMeters[peerId].isRunning)) {
                    console.log(`üîä –°–æ–∑–¥–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ ${peerId}`);
                    createAudioAnalyzer(stream, peerId);
                } else {
                    console.log(`‚ö†Ô∏è –ü–æ—Ç–æ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è ${peerId}`);
                }
            }, 1000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –ª—É—á—à–µ–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
        }
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à–∏ –∞—É–¥–∏–æ—Ç—Ä–µ–∫–∏ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    if (localStream) {
        const audioTracks = localStream.getAudioTracks();
        if (audioTracks.length > 0) {
            audioTracks.forEach(track => {
                console.log(`–î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ —Ç—Ä–µ–∫ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerName}:`, {
                    kind: track.kind,
                    enabled: track.enabled,
                    readyState: track.readyState,
                    label: track.label
                });
                pc.addTrack(track, localStream);
            });
            console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${audioTracks.length} –∞—É–¥–∏–æ —Ç—Ä–µ–∫–æ–≤ –¥–ª—è ${peerName}`);
        } else {
            console.error(`‚ùå –ù–µ—Ç –∞—É–¥–∏–æ —Ç—Ä–µ–∫–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ –¥–ª—è ${peerName}`);
        }
    } else {
        console.error(`‚ùå –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${peerName}`);
        // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –∑–∞–Ω–æ–≤–æ
        console.log('–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞...');
        startMedia().then(() => {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    console.log(`üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫ –¥–ª—è ${peerName}`);
                    pc.addTrack(track, localStream);
                });
            }
        }).catch(err => {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫:', err);
        });
    }

    peerConnections[peerId] = pc;
    console.log(`–°–æ–∑–¥–∞–Ω–æ PeerConnection –¥–ª—è ${peerName} (${peerId})`);
    return pc;
}

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

let currentUsers = [];
function updateUsersList(fullList, newUser, removedUserId) {
    if (fullList) {
        currentUsers = fullList;
    } else if (newUser) {
        currentUsers.push(newUser);
    } else if (removedUserId) {
        currentUsers = currentUsers.filter(u => u.id !== removedUserId);
        // –£–¥–∞–ª—è–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        removeVolumeAnalyzer(removedUserId);
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ UI
    const existingUserElements = Array.from(usersList.children);
    const existingUserIds = existingUserElements.map(el => {
        const match = el.id.match(/user-item-(.+)/);
        return match ? match[1] : null;
    }).filter(Boolean);
    
    // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç
    const currentUserIds = currentUsers.map(u => u.id);
    existingUserIds.forEach(userId => {
        if (!currentUserIds.includes(userId)) {
            const element = document.getElementById(`user-item-${userId}`);
            if (element) {
                console.log(`üóëÔ∏è –£–¥–∞–ª—è–µ–º UI —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è ${userId}`);
                element.remove();
            }
        }
    });
    
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    currentUsers.forEach(user => {
        let userItem = document.getElementById(`user-item-${user.id}`);
        if (!userItem) {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
            userItem = createUserVolumeIndicator(user.id, user.name);
            usersList.appendChild(userItem);
            console.log(`‚ûï –°–æ–∑–¥–∞–Ω UI —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è ${user.name} (${user.id})`);
            
            // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–∑–¥–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            if (user.id === myPeerId && localStream && !localAudioAnalyzer) {
                createLocalAudioAnalyzer();
            }
        } else {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç (–∏–º—è –º–æ–≥–ª–æ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
            const nameElement = userItem.querySelector('.user-name');
            if (nameElement && nameElement.textContent !== user.name) {
                nameElement.textContent = user.name;
                console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–º—è –¥–ª—è ${user.id}: ${user.name}`);
            }
        }
    });
}


async function startMedia() {
    if (!localStream) {
        try {
            console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
            localStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            console.log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞—Ö–≤–∞—á–µ–Ω');
            console.log('–ê—É–¥–∏–æ—Ç—Ä–µ–∫–∏:', localStream.getAudioTracks().map(t => ({
                kind: t.kind,
                enabled: t.enabled,
                readyState: t.readyState,
                label: t.label
            })));
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
            throw error;
        }
    }
}

function createLocalAudioAnalyzer() {
    if (localStream && myPeerId && !localAudioAnalyzer) {
        try {
            console.log('üé§ –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∞—É–¥–∏–æ...');
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(localStream);
            const analyser = audioContext.createAnalyser();
            
            analyser.fftSize = 256;
            analyser.smoothingTimeConstant = 0.85;
            source.connect(analyser);
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            localAudioAnalyzer = {
                analyser: analyser,
                dataArray: dataArray,
                audioContext: audioContext,
                smoothedVolume: 0,
                isRunning: false
            };
            
            // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—â–∏–π volumeMeters –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
            volumeMeters[myPeerId] = localAudioAnalyzer;
            
            console.log('‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∞—É–¥–∏–æ —Å–æ–∑–¥–∞–Ω');
            startVolumeMonitoring(myPeerId);
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –≤–æ –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            ensureTracksInAllConnections();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞:', error);
        }
    } else if (localAudioAnalyzer) {
        console.log('‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω
        if (!localAudioAnalyzer.isRunning) {
            startVolumeMonitoring(myPeerId);
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤ –≤–æ –≤—Å–µ peer connections
function ensureTracksInAllConnections() {
    if (!localStream) {
        console.warn('‚ö†Ô∏è –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤');
        return;
    }
    
    const audioTracks = localStream.getAudioTracks();
    if (audioTracks.length === 0) {
        console.warn('‚ö†Ô∏è –ù–µ—Ç –∞—É–¥–∏–æ —Ç—Ä–µ–∫–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ');
        return;
    }
    
    console.log('üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–∫–∏ –≤–æ –≤—Å–µ—Ö peer connections...');
    
    Object.entries(peerConnections).forEach(([peerId, pc]) => {
        const senders = pc.getSenders();
        const audioSenders = senders.filter(sender => sender.track && sender.track.kind === 'audio');
        
        console.log(`PC ${peerId}: ${audioSenders.length} –∞—É–¥–∏–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π –∏–∑ ${senders.length} –æ–±—â–∏—Ö`);
        
        if (audioSenders.length === 0) {
            console.log(`‚ûï –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∏ –¥–ª—è ${peerId}`);
            audioTracks.forEach(track => {
                try {
                    pc.addTrack(track, localStream);
                    console.log(`‚úÖ –¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${peerId}:`, track.label);
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ –¥–ª—è ${peerId}:`, error);
                }
            });
        } else {
            console.log(`‚úÖ –¢—Ä–µ–∫–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–ª—è ${peerId}`);
        }
    });
}

function cleanup() {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    stopUserAutoRefresh();
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    for (const peerId in peerConnections) {
        peerConnections[peerId].close();
    }
    peerConnections = {};

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –æ—Ç–∫—Ä—ã—Ç
    if (ws && ws.readyState !== WebSocket.CLOSED) {
        ws.onmessage = null; // —É–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        ws.onclose = null;
        ws.close();
    }
    ws = null;
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞—Ö–≤–∞—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    localStream?.getTracks().forEach(track => track.stop());
    localStream = null;
    
    // –û—á–∏—â–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    Object.keys(volumeMeters).forEach(peerId => {
        removeVolumeAnalyzer(peerId);
    });
    volumeMeters = {};
    
    // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
    if (localAudioAnalyzer && localAudioAnalyzer.audioContext) {
        localAudioAnalyzer.audioContext.close();
    }
    localAudioAnalyzer = null;

    // –°–∫—Ä—ã–≤–∞–µ–º UI –∑–≤–æ–Ω–∫–∞
    callUI.classList.add('hidden');
    currentRoom.textContent = '';
    usersList.innerHTML = '';
    document.getElementById('audio-container').innerHTML = '';
    currentUsers = [];
    
    // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
    startRoomAutoRefresh();
    
    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    connectToMainMenu();
    
    console.log('üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫ —Å–ø–∏—Å–∫—É –∫–æ–º–Ω–∞—Ç');
}

leave.onclick = () => { cleanup(); };
muteMic.onclick = () => {
    if(localStream) {
        const enabled = localStream.getAudioTracks()[0].enabled;
        localStream.getAudioTracks()[0].enabled = !enabled;
        muteMic.textContent = enabled ? "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª." : "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª.";
    }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–≤—Ç–æ–ø–ª–µ—è
function showPlayButton(peerId, peerName, audioEl) {
    const existingBtn = document.getElementById(`play_${peerId}`);
    if (existingBtn) return; // –ö–Ω–æ–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    
    const playBtn = document.createElement('button');
    playBtn.id = `play_${peerId}`;
    playBtn.textContent = `‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –æ—Ç ${peerName}`;
    playBtn.style.margin = '5px';
    playBtn.style.padding = '10px';
    playBtn.style.backgroundColor = '#4CAF50';
    playBtn.style.color = 'white';
    playBtn.style.border = 'none';
    playBtn.style.borderRadius = '4px';
    playBtn.style.cursor = 'pointer';
    
    playBtn.onclick = async () => {
        try {
            await audioEl.play();
            playBtn.remove();
            console.log(`–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è ${peerName} —É—Å–ø–µ—à–µ–Ω`);
        } catch (err) {
            console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è ${peerName}:`, err);
            alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –æ—Ç ${peerName}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.`);
        }
    };
    
    document.getElementById('usersList').appendChild(playBtn);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∞—É–¥–∏–æ –ø—Ä–æ–±–ª–µ–º
function diagnoseAudio() {
    console.log('===============================================');
    console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ê–£–î–ò–û');
    console.log('===============================================');
    
    // 1. –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
    console.log('\n1Ô∏è‚É£ –õ–û–ö–ê–õ–¨–ù–´–ô –ü–û–¢–û–ö:');
    console.log('–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫:', localStream);
    if (localStream) {
        const tracks = localStream.getTracks();
        const audioTracks = localStream.getAudioTracks();
        console.log(`‚úÖ –û–±—â–∏–µ —Ç—Ä–µ–∫–∏: ${tracks.length}, –ê—É–¥–∏–æ —Ç—Ä–µ–∫–∏: ${audioTracks.length}`);
        audioTracks.forEach((track, idx) => {
            console.log(`  üé§ –ê—É–¥–∏–æ —Ç—Ä–µ–∫ ${idx}:`, {
                enabled: track.enabled,
                readyState: track.readyState,
                label: track.label,
                kind: track.kind,
                muted: track.muted
            });
        });
    } else {
        console.log('‚ùå –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –û–¢–°–£–¢–°–¢–í–£–ï–¢!');
    }
    
    // 2. Peer Connections
    console.log('\n2Ô∏è‚É£ PEER CONNECTIONS:');
    const peerIds = Object.keys(peerConnections);
    console.log(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${peerIds.length}`);
    
    if (peerIds.length === 0) {
        console.log('‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö peer connections!');
    }
    
    peerIds.forEach(peerId => {
        const pc = peerConnections[peerId];
        console.log(`\n  üîó PC ${peerId}:`);
        console.log(`    –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${pc.connectionState}`);
        console.log(`    ICE: ${pc.iceConnectionState}`);
        console.log(`    –°–∏–≥–Ω–∞–ª–∏–Ω–≥: ${pc.signalingState}`);
        
        // –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏ (–Ω–∞—à–∏ —Ç—Ä–µ–∫–∏)
        const senders = pc.getSenders();
        const audioSenders = senders.filter(s => s.track && s.track.kind === 'audio');
        console.log(`    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏: ${senders.length} (–∞—É–¥–∏–æ: ${audioSenders.length})`);
        audioSenders.forEach((sender, idx) => {
            console.log(`      üé§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å ${idx}:`, {
                enabled: sender.track.enabled,
                readyState: sender.track.readyState,
                label: sender.track.label
            });
        });
        
        // –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ (—Ç—Ä–µ–∫–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö)
        const receivers = pc.getReceivers();
        const audioReceivers = receivers.filter(r => r.track && r.track.kind === 'audio');
        console.log(`    üì• –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: ${receivers.length} (–∞—É–¥–∏–æ: ${audioReceivers.length})`);
        audioReceivers.forEach((receiver, idx) => {
            console.log(`      üé¨ –ü–æ–ª—É—á–∞—Ç–µ–ª—å ${idx}:`, {
                enabled: receiver.track.enabled,
                readyState: receiver.track.readyState,
                label: receiver.track.label
            });
        });
        
        if (audioSenders.length === 0) {
            console.log(`    ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Ç –∞—É–¥–∏–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π!`);
        }
        if (audioReceivers.length === 0) {
            console.log(`    ‚ö†Ô∏è –ù–µ—Ç –∞—É–¥–∏–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π`);
        }
    });
    
    // 3. –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã
    console.log('\n3Ô∏è‚É£ –ê–£–î–ò–û –≠–õ–ï–ú–ï–ù–¢–´:');
    const audioElements = document.querySelectorAll('audio');
    console.log(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${audioElements.length}`);
    audioElements.forEach((audio, idx) => {
        console.log(`  üîä –≠–ª–µ–º–µ–Ω—Ç ${idx} (${audio.id}):`, {
            srcObject: !!audio.srcObject,
            paused: audio.paused,
            volume: audio.volume,
            muted: audio.muted,
            readyState: audio.readyState,
            currentTime: audio.currentTime,
            duration: audio.duration
        });
        
        if (audio.srcObject) {
            const stream = audio.srcObject;
            const tracks = stream.getTracks();
            console.log(`    –ü–æ—Ç–æ–∫: ${tracks.length} —Ç—Ä–µ–∫–æ–≤`);
            tracks.forEach(track => {
                console.log(`      ${track.kind}: ${track.enabled}, ${track.readyState}`);
            });
        }
    });
    
    // 4. –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    console.log('\n4Ô∏è‚É£ –ê–ù–ê–õ–ò–ó–ê–¢–û–†–´ –ì–†–û–ú–ö–û–°–¢–ò:');
    const analyzerIds = Object.keys(volumeMeters);
    console.log(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–≤: ${analyzerIds.length}`);
    analyzerIds.forEach(peerId => {
        const meter = volumeMeters[peerId];
        console.log(`  üìä ${peerId}:`, {
            audioContext: meter.audioContext ? meter.audioContext.state : 'null',
            analyser: !!meter.analyser,
            dataArrayLength: meter.dataArray ? meter.dataArray.length : 0
        });
    });
    
    console.log(`–õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä: ${!!localAudioAnalyzer}`);
    
    // 5. –û–±—â–∞—è —Å–≤–æ–¥–∫–∞
    console.log('\n5Ô∏è‚É£ –°–í–û–î–ö–ê:');
    console.log(`‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫: ${!!localStream}`);
    console.log(`‚úÖ Peer connections: ${peerIds.length}`);
    console.log(`‚úÖ –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã: ${audioElements.length}`);
    console.log(`‚úÖ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã: ${analyzerIds.length}`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
    console.log('\nüî¥ –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:');
    let problemsFound = 0;
    
    if (!localStream) {
        console.log('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫!');
        problemsFound++;
    } else if (localStream.getAudioTracks().length === 0) {
        console.log('‚ùå –ù–µ—Ç –∞—É–¥–∏–æ —Ç—Ä–µ–∫–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ!');
        problemsFound++;
    }
    
    peerIds.forEach(peerId => {
        const pc = peerConnections[peerId];
        const audioSenders = pc.getSenders().filter(s => s.track && s.track.kind === 'audio');
        if (audioSenders.length === 0) {
            console.log(`‚ùå ${peerId}: –ù–µ—Ç –∞—É–¥–∏–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π!`);
            problemsFound++;
        }
    });
    
    if (problemsFound === 0) {
        console.log('‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ');
    } else {
        console.log(`‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${problemsFound} –ø—Ä–æ–±–ª–µ–º(—ã)`);
        console.log('\nüí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:');
        console.log('1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫–∏"');
        console.log('2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
        console.log('3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
    }
    
    console.log('===============================================');
}

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
const diagBtn = document.createElement('button');
diagBtn.textContent = 'üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∞—É–¥–∏–æ';
diagBtn.onclick = diagnoseAudio;
diagBtn.style.margin = '5px';
document.getElementById('controls').appendChild(diagBtn);

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–∫–æ–≤
const syncBtn = document.createElement('button');
syncBtn.textContent = 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫–∏';
syncBtn.onclick = () => {
    console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–∫–æ–≤...');
    ensureTracksInAllConnections();
    
    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (localStream && myPeerId && !localAudioAnalyzer) {
        createLocalAudioAnalyzer();
    }
    
    alert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–∫–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
};
syncBtn.style.margin = '5px';
syncBtn.style.backgroundColor = '#FF9800';
syncBtn.style.color = 'white';
syncBtn.style.border = 'none';
syncBtn.style.padding = '8px 12px';
syncBtn.style.borderRadius = '4px';
syncBtn.style.cursor = 'pointer';
document.getElementById('controls').appendChild(syncBtn);

</script>
</body>
</html>
