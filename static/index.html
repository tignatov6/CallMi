<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Python Call Site</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 1em auto; }
        #rooms { margin-bottom: 1rem; }
        video, audio { display: none; }
        .hidden { display: none; }
        button { margin: 0.2em; padding: 0.5em; }
        input { margin: 0.2em; padding: 0.4em; }
    </style>
</head>
<body>
    <h1>–ó–≤–æ–Ω–∫–∏</h1>

    <div id="login">
        –í–∞—à–µ –∏–º—è: <input id="userName" placeholder="–ò–º—è">
        <button id="enterBtn">–í–æ–π—Ç–∏</button>
    </div>

    <div id="main" class="hidden">
        <section id="rooms"></section>

        <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
        –ù–∞–∑–≤–∞–Ω–∏–µ: <input id="roomName">
        –ü–∞—Ä–æ–ª—å (–æ–ø—Ü.): <input id="roomPwd" type="password">
        <button id="createRoom">–°–æ–∑–¥–∞—Ç—å</button>

        <h2 id="roomTitle" class="hidden">–ö–æ–º–Ω–∞—Ç–∞: <span id="currentRoom"></span></h2>
        <div id="controls" class="hidden">
            <button id="leave">–í—ã–π—Ç–∏</button>
            <button id="muteMic">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª.</button>
            <button id="muteSpk">–î–∏–Ω–∞–º–∏–∫–∏ –≤—ã–∫–ª.</button><br />
            –ì—Ä–æ–º–∫–æ—Å—Ç—å –≤—Ö–æ–¥.: <input id="inVol" type="range" min="0" max="250" value="100">
            –ú–∏–∫—Ä–æ—Ñ–æ–Ω: <input id="outVol" type="range" min="0" max="250" value="100">
        </div>
    </div>

<script>
let token = {}, ws = null, pc = null, localStream = null,
    roomsDiv = document.getElementById('rooms');

const gainCtx = new AudioContext();
let inGain = gainCtx.createGain();
let micGain = gainCtx.createGain();

document.getElementById('enterBtn').onclick = () => {
    token.name = userName.value || '–ì–æ—Å—Ç—å' + Math.random().toString(36).slice(2, 5);
    login.classList.add('hidden');
    main.classList.remove('hidden');
    loadRooms();
};

document.getElementById('createRoom').onclick = async () => {
    const r = await fetch('/api/rooms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: roomName.value, password: roomPwd.value })
    });
    if (r.ok) {
        roomName.value = ''; roomPwd.value = '';
        loadRooms();
    } else {
        alert(await r.text());
    }
};

async function loadRooms() {
    roomsDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    const lst = await (await fetch('/api/rooms')).json();
    roomsDiv.innerHTML = lst.map(r =>
        `<button onclick="join(${r.id},'${r.name}',${r.has_password})">
       –í–æ–π—Ç–∏: ${r.name}${r.has_password ? ' üîí' : ''}</button>`).join('<br>');
}

// --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–•–û–î–ê –í –ö–û–ú–ù–ê–¢–£ ---
window.join = async (id, name, hasPwd) => {
    if (ws) { alert('–£–∂–µ –≤ –∫–æ–º–Ω–∞—Ç–µ'); return; }
    const pwd = hasPwd ? prompt('–ü–∞—Ä–æ–ª—å –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã "' + name + '"') : '';
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞" –≤ –æ–∫–Ω–µ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
    if (hasPwd && pwd === null) return;

    ws = new WebSocket(`ws://${location.host}/ws/${id}`);

    try {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –î–û –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        ws.onmessage = e => handleSignal(JSON.parse(e.data));
        ws.onclose = (event) => {
            console.log('WebSocket closed:', event.code, event.reason);
            if (event.code === 4000) {
                alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å.');
            } else if (event.code > 1001) {
                alert(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ —Å –æ—à–∏–±–∫–æ–π: ${event.reason}`);
            }
            cleanup();
        };

        // –ñ–¥–µ–º, –ø–æ–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
        await new Promise((resolve, reject) => {
            ws.onopen = resolve;
            ws.onerror = (err) => reject(new Error("–û—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è."));
        });

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å –∫–∞–∫ –ü–ï–†–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ
        ws.send(JSON.stringify({ password: pwd }));

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –ø—Ä–æ–≥—Ä–µ—Å—Å
        roomTitle.classList.remove('hidden');
        controls.classList.remove('hidden');
        currentRoom.textContent = name;

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
        await startMedia();

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        pc.onicecandidate = ({ candidate }) => candidate && ws.send(JSON.stringify({ ice: candidate }));
        pc.ontrack = ({ streams: [s] }) => {
            const src = gainCtx.createMediaStreamSource(s);
            src.connect(inGain).connect(gainCtx.destination);
        };
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        pc.addTrack(micGain.stream.getAudioTracks()[0], localStream);
        inGain.gain.value = 1; micGain.gain.value = 1;

        // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º SDP offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ sdp: pc.localDescription }));

    } catch (err) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É:", err);
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            alert('–û—à–∏–±–∫–∞: –í—ã –Ω–µ —Ä–∞–∑—Ä–µ—à–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.');
        } else {
            alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ${err.message}`);
        }
        ws?.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–∫–µ—Ç, –µ—Å–ª–∏ –æ–Ω —É—Å–ø–µ–ª –æ—Ç–∫—Ä—ã—Ç—å—Å—è
        cleanup();   // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    }
};

async function handleSignal(msg) {
    if (!pc) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã, –µ—Å–ª–∏ –º—ã –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–≤–æ–Ω–∫–∞
    if (msg.sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
        if (msg.sdp.type === 'offer') {
            const ans = await pc.createAnswer();
            await pc.setLocalDescription(ans);
            ws.send(JSON.stringify({ sdp: pc.localDescription }));
        }
    } else if (msg.ice) {
        await pc.addIceCandidate(new RTCIceCandidate(msg.ice));
    }
}

async function startMedia() {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const dest = gainCtx.createMediaStreamDestination();
    const src = gainCtx.createMediaStreamSource(localStream);
    src.connect(micGain).connect(dest);
    micGain.stream = dest.stream; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ç–æ–∫ —Å —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–æ–π –≥—Ä–æ–º–∫–æ—Å—Ç–∏
}

function cleanup() {
    pc?.close(); pc = null;
    ws = null; // ws?.close() –≤—ã–∑–æ–≤–µ—Ç cleanup, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –æ–±–Ω—É–ª—è–µ–º
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    roomTitle.classList.add('hidden');
    controls.classList.add('hidden');
    currentRoom.textContent = '';
}

leave.onclick = () => { ws?.close(); };
muteMic.onclick = () => { if(localStream) localStream.getAudioTracks()[0].enabled ^= true; };
muteSpk.onclick = () => { inGain.gain.value = inGain.gain.value ? 0 : 1; };
inVol.oninput = e => inGain.gain.value = e.target.value / 100 * 2.5;
outVol.oninput = e => micGain.gain.value = e.target.value / 100 * 2.5;
</script>
</body>
</html>
