<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Python Call Site</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 1em auto; }
        #rooms { margin-bottom: 1rem; }
        #audio-container, video { display: none; }
        .hidden { display: none; }
        button { margin: 0.2em; padding: 0.5em; }
        input { margin: 0.2em; padding: 0.4em; }
        #usersList { border: 1px solid #ccc; padding: 0.5em; min-height: 50px; margin-top: 1em; }
    </style>
</head>
<body>
    <h1>–ó–≤–æ–Ω–∫–∏</h1>

    <div id="login">
        –í–∞—à–µ –∏–º—è: <input id="userName" placeholder="–ò–º—è">
        <button id="enterBtn">–í–æ–π—Ç–∏</button>
    </div>

    <div id="main" class="hidden">
        <section id="rooms"></section>

        <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
        –ù–∞–∑–≤–∞–Ω–∏–µ: <input id="roomName">
        –ü–∞—Ä–æ–ª—å (–æ–ø—Ü.): <input id="roomPwd" type="password">
        <button id="createRoom">–°–æ–∑–¥–∞—Ç—å</button>

        <div id="callUI" class="hidden">
            <h2 id="roomTitle">–ö–æ–º–Ω–∞—Ç–∞: <span id="currentRoom"></span></h2>
            <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>
            <div id="usersList"></div>
            <div id="controls">
                <button id="leave">–í—ã–π—Ç–∏</button>
                <button id="muteMic">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª.</button>
                <!-- –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª MuteSpk –∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ —É–±—Ä–∞–Ω –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, —Ç.–∫. –∞—É–¥–∏–æ —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
    
    <div id="audio-container"></div>

<script>
let myPeerId = null, myName = null, ws = null, localStream = null;
let peerConnections = {}; // { peerId: RTCPeerConnection }
const roomsDiv = document.getElementById('rooms');

// --- –í—Ö–æ–¥ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç (–±–µ–∑ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
document.getElementById('enterBtn').onclick = () => {
    myName = userName.value || '–ì–æ—Å—Ç—å' + Math.random().toString(36).slice(2, 5);
    myPeerId = `peer_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`; // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
    login.classList.add('hidden');
    main.classList.remove('hidden');
    loadRooms();
};

document.getElementById('createRoom').onclick = async () => {
    const r = await fetch('/api/rooms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: roomName.value, password: roomPwd.value })
    });
    if (r.ok) {
        roomName.value = ''; roomPwd.value = '';
        loadRooms();
    } else { alert(await r.text()); }
};

async function loadRooms() {
    roomsDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    const lst = await (await fetch('/api/rooms')).json();
    roomsDiv.innerHTML = lst.map(r =>
        `<button onclick="join(${r.id},'${r.name}',${r.has_password})">
       –í–æ–π—Ç–∏: ${r.name}${r.has_password ? ' üîí' : ''}</button>`).join('<br>');
}


// --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ò WEBRTC ---

window.join = async (id, name, hasPwd) => {
    if (ws) { alert('–£–∂–µ –≤ –∫–æ–º–Ω–∞—Ç–µ'); return; }
    let pwd = '';
    if (hasPwd) {
        pwd = prompt('–ü–∞—Ä–æ–ª—å –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã "' + name + '"');
        if (pwd === null) return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞"
    }

    try {
        await startMedia(); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞—Ä–∞–Ω–µ–µ

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${location.host}/ws/${id}/${myPeerId}/${encodeURIComponent(myName)}${pwd ? '?password=' + encodeURIComponent(pwd) : ''}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log("WebSocket connection established");
            callUI.classList.remove('hidden');
            currentRoom.textContent = name;
        };
        
        ws.onmessage = e => handleWsMessage(JSON.parse(e.data));
        
        ws.onclose = (event) => {
            console.log('WebSocket closed:', event.code, event.reason);
            if (event.code >= 4000) {
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: ${event.reason}`);
            }
            cleanup();
        };
        
        ws.onerror = (err) => {
            console.error("WebSocket error:", err);
            alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.");
            cleanup();
        };

    } catch (err) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É:", err);
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            alert('–û—à–∏–±–∫–∞: –í—ã –Ω–µ —Ä–∞–∑—Ä–µ—à–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.');
        } else {
            alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ${err.message}`);
        }
        cleanup();
    }
};

async function handleWsMessage(msg) {
    console.log("Received message:", msg);
    const { type, payload, from_id } = msg;

    switch (type) {
        // –°–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∏–ª –Ω–∞–º, –∫—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–º–Ω–∞—Ç–µ
        case 'room_state':
            updateUsersList(payload.concat({id: myPeerId, name: `${myName} (–í—ã)`}));
            // –°–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∫–∞–∂–¥—ã–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∏—Ä–æ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
            for (const peer of payload) {
                const pc = createPeerConnection(peer.id, peer.name);
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                ws.send(JSON.stringify({ to_id: peer.id, type: 'sdp', payload: pc.localDescription }));
            }
            break;

        // –í –∫–æ–º–Ω–∞—Ç—É –≤–æ—à–µ–ª –Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫
        case 'new_peer':
            updateUsersList(null, payload);
            // –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–∑–¥–∞—Å—Ç offer, –º—ã –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º PC –∏ –∂–¥–µ–º
            createPeerConnection(payload.id, payload.name);
            break;

        // –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É
        case 'peer_left':
            updateUsersList(null, null, payload.id);
            if (peerConnections[payload.id]) {
                peerConnections[payload.id].close();
                delete peerConnections[payload.id];
            }
            const audioEl = document.getElementById(`audio_${payload.id}`);
            if (audioEl) audioEl.remove();
            break;

        // –ü–æ–ª—É—á–∏–ª–∏ SDP (offer –∏–ª–∏ answer)
        case 'sdp':
            const pc = peerConnections[from_id];
            if (pc) {
                await pc.setRemoteDescription(new RTCSessionDescription(payload));
                if (payload.type === 'offer') {
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    ws.send(JSON.stringify({ to_id: from_id, type: 'sdp', payload: pc.localDescription }));
                }
            }
            break;

        // –ü–æ–ª—É—á–∏–ª–∏ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç
        case 'ice':
            await peerConnections[from_id]?.addIceCandidate(new RTCIceCandidate(payload));
            break;
    }
}

function createPeerConnection(peerId, peerName) {
    const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    
    pc.onicecandidate = ({ candidate }) => {
        if (candidate) {
            ws.send(JSON.stringify({ to_id: peerId, type: 'ice', payload: candidate }));
        }
    };
    
    pc.ontrack = ({ streams: [stream] }) => {
        let audioEl = document.getElementById(`audio_${peerId}`);
        if (!audioEl) {
            audioEl = document.createElement('audio');
            audioEl.id = `audio_${peerId}`;
            audioEl.autoplay = true;
            audioEl.playsInline = true;
            document.getElementById('audio-container').appendChild(audioEl);
        }
        audioEl.srcObject = stream;
        console.log(`–ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–ø–æ—Ç–æ–∫ –æ—Ç ${peerName} (${peerId})`);
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à–∏ –∞—É–¥–∏–æ—Ç—Ä–µ–∫–∏ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    peerConnections[peerId] = pc;
    console.log(`–°–æ–∑–¥–∞–Ω–æ PeerConnection –¥–ª—è ${peerName} (${peerId})`);
    return pc;
}

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

let currentUsers = [];
function updateUsersList(fullList, newUser, removedUserId) {
    if (fullList) {
        currentUsers = fullList;
    } else if (newUser) {
        currentUsers.push(newUser);
    } else if (removedUserId) {
        currentUsers = currentUsers.filter(u => u.id !== removedUserId);
    }
    
    usersList.innerHTML = currentUsers.map(u => `<div>${u.name}</div>`).join('');
}


async function startMedia() {
    if (!localStream) {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }
}

function cleanup() {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    for (const peerId in peerConnections) {
        peerConnections[peerId].close();
    }
    peerConnections = {};

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –æ—Ç–∫—Ä—ã—Ç
    if (ws && ws.readyState !== WebSocket.CLOSED) {
        ws.onmessage = null; // —É–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        ws.onclose = null;
        ws.close();
    }
    ws = null;
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞—Ö–≤–∞—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    localStream?.getTracks().forEach(track => track.stop());
    localStream = null;

    // –°–∫—Ä—ã–≤–∞–µ–º UI –∑–≤–æ–Ω–∫–∞
    callUI.classList.add('hidden');
    currentRoom.textContent = '';
    usersList.innerHTML = '';
    document.getElementById('audio-container').innerHTML = '';
    currentUsers = [];
}

leave.onclick = () => { cleanup(); };
muteMic.onclick = () => {
    if(localStream) {
        const enabled = localStream.getAudioTracks()[0].enabled;
        localStream.getAudioTracks()[0].enabled = !enabled;
        muteMic.textContent = enabled ? "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª." : "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª.";
    }
};

</script>
</body>
</html>
